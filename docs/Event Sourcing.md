# Event Sourcing

애플리케이션의 상태를 저장하는 전통적인 방식에서, 보통 현재 상태를 찾거나, 저장할 때는 보통 관계형 DB나 NoSQL을 사용하였다. 이런 방식은 아주 직관적이지만, 어떻게 현재 상태에 도달하게 되었는지에 대한 정보를 알려주지는 않는다.

이벤트 소싱은 과거에 발생한 이벤트들의 히스토리를 통해 애플리케이션의 상태를 저장하는 방식을 말한다. 현재 상태는 이벤트의 히스토리를 기반으로 복원된다. 이벤트는 애플리케이션에서 발생한 사실에 대한 정보를 가지고 있다. 이는 외부 리뷰어에게 추적 로그를 제공해줘야 하는 애플리케이션에 대해서 이점이 있다. 현재 상태를 Materialized state라고 불린다.

![img](https://gblobscdn.gitbook.com/assets%2F-LOb1hJMvj2flvCj-pr_%2Fsync%2F52040eb40225152e3130422305e322c41f45129e.jpeg?alt=media)



이벤트 소싱이 전통적인 저장 방식과 다른 점이 무엇인지 예제를 통해 알아보자. 

![img](https://gblobscdn.gitbook.com/assets%2F-LOb1hJMvj2flvCj-pr_%2Fsync%2Fe0a975dffa9dce79409db7198c4ae841b77a9471.png?alt=media)

4번째 줄을 보면, 전통적인 저장 방식에서는, 오직 피자와 콜라를 주문했다는 사실만을 알 수 있다. 이벤트 소싱에서는, 사용자가 피자를 선택했고, 콜라도 선택했고, 아이스크림을 선택했지만, 아이스크림 선택을 취소했다는 정보도 알 수 있다. 이벤트 소싱에서는, 사용자가 아이스크림을 왜 취소했는지에 대한 판단을 할 수 있다. (아이스크림 가격이 비싸다거나 등등..) 여기서 중요한 점은 이런 정보도 잃어버리지 않고, 이러한 정보로 피드백을 얻을 수도 있고 등등.. 여러가지 활용할 점이 생길 수 있다는 것이다.



## Event Store

이벤트 소싱은 이벤트를 저장하기 위한 이벤트 저장소가 필요하다. 이벤트가 변경되지 않기 때문에, 이벤트 저장소는 append 연산에 최적화 되어야 한다. 이벤트 ordering은 이벤트 소싱 기반 시스템에서 아주 중요한 역할을 한다. (상태 원복 같은 거를 할 때 사용) 

Axon server는 Axon에서 기본 선택 사항이고, Axon server는 엔터프라이즈 급의 목적으로 사용되는 이벤트 저장소를 제공한다. (이벤트 저장 / 검색을 아주 잘 최적화 해놨다고 함.) 서버는 Standard / Enterprise 에디션이 있다.

Axon Framework는 RDBMS 과 NoSQL 둘 중 하나를 선택하여 이벤트 스토어로 사용할 수 있도록 지원한다.





## Event Sourcing and CQRS

이벤트 소싱은 CQRS와 찰떡이다. 전형적으로, CQRS의 커맨드 모델은 이벤트 순서에 의해 저장되지 않는다. 쿼리 모델은 동일한 이벤트에 기반하여 현재 상태의 특정 표현을 포함하도록 지속적으로 업데이트 된다. 

전체 커맨드 모델 상태를 재건하는 것 대신, 모델을 애그리거트로 분리시킨다. 애그리거트로의 분리는 모델을 이해하기 쉽고, 변화에 더 잘 적응할 수 있게 하며, 애플리케이션의 확장성을 향상시킨다.

